<!DOCTYPE html>
<html>
<head>
  <title>Sales Pipeline CRM</title>
  <style>
    body { font-family: Arial; background:#f5f7fb; margin:0 }
    header { padding:20px; background:#fff; display:flex; justify-content:space-between }
    .box { background:#fff; padding:20px; border-radius:10px; margin:10px }
    .grid { display:flex; gap:20px }
    button { padding:10px; background:#4f46e5; color:#fff; border:none; border-radius:8px }
    .card { border:1px solid #eee; padding:10px; margin-bottom:10px; border-radius:8px }
    .delete { background:red }
  </style>
</head>
<body>

<header>
  <h2>Sales Pipeline CRM</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="grid">
  <div class="box">
    <h3>Add New Lead</h3>
    <input id="company" placeholder="Company"><br><br>
    <input id="person" placeholder="Contact Person"><br><br>
    <input id="email" placeholder="Email"><br><br>
    <input id="phone" placeholder="Phone"><br><br>
    <input id="value" placeholder="Deal Value"><br><br>
    <button onclick="addLead()">Add Lead</button>
  </div>

  <div class="box" style="flex:1">
    <h3>Leads</h3>
    <div id="leads"></div>
  </div>
</div>

<script>
const token = localStorage.getItem("token");

if (!token) location.href = "/login.html";

function logout() {
  localStorage.removeItem("token");
  location.href = "/login.html";
}

async function loadLeads() {
  const res = await fetch("/api/leads", {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  document.getElementById("leads").innerHTML = "";
  data.forEach(l => {
    document.getElementById("leads").innerHTML += `
      <div class="card">
        <b>${l.companyName}</b><br>
        â‚¹${l.dealValue}<br>
        ${l.contactPerson}<br>
        ${l.email}<br>
        ${l.phone}<br>
        <select onchange="updateStage('${l._id}', this.value)">
          ${["Lead","Contacted","Qualified","Proposal","Won","Lost"].map(s =>
            `<option ${s===l.stage?"selected":""}>${s}</option>`
          ).join("")}
        </select><br><br>
        <button class="delete" onclick="deleteLead('${l._id}')">Delete</button>
      </div>
    `;
  });
}

async function addLead() {
  await fetch("/api/leads", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({
      companyName: company.value,
      contactPerson: person.value,
      email: email.value,
      phone: phone.value,
      dealValue: value.value
    })
  });

  company.value = person.value = email.value = phone.value = value.value = "";
  loadLeads();
}

async function updateStage(id, stage) {
  await fetch("/api/leads/" + id, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ stage })
  });
  loadLeads();
}

async function deleteLead(id) {
  await fetch("/api/leads/" + id, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  loadLeads();
}

loadLeads();
</script>
</body>
</html>
