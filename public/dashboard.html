<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales Pipeline CRM</title>
<script src="/socket.io/socket.io.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --accent:#4f46e5;
  --danger:#dc2626;
  --success:#16a34a;
  --loss:#b91c1c;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Segoe UI",system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:var(--card);
  padding:16px 30px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1{
  margin:0;
  font-size:20px;
}

/* LOGOUT BUTTON (FIXED SIZE) */
.logout-btn{
  width:auto;
  padding:8px 18px;
  background:var(--danger);
  color:white;
  border:none;
  border-radius:10px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
}

/* PAGE */
.container{padding:25px}

/* SUMMARY */
.summary{
  display:flex;
  gap:20px;
  margin-bottom:25px;
}

.summary .box{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  flex:1;
  box-shadow:0 6px 20px rgba(0,0,0,0.05);
}

.summary h4{
  margin:0;
  color:var(--muted);
  font-size:14px;
}

.summary p{
  margin:6px 0 0;
  font-size:18px;
  font-weight:700;
}

/* TOP SECTION */
.top-section{
  display:flex;
  gap:30px;
}

/* ADD LEAD CARD */
.add-card{
  width:360px;
  background:var(--card);
  padding:20px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,0.05);
}

.add-card h3{margin-top:0}

/* FORM ELEMENTS */
input,select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}

/* FORM BUTTON ONLY */
.form-btn{
  width:100%;
  padding:10px;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

/* PIPELINE */
.pipeline{
  display:flex;
  gap:15px;
  flex:1;
  overflow-x:auto;
}

.column{
  background:var(--card);
  min-width:240px;
  padding:12px;
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,0.05);
}

.column h3{
  text-align:center;
  font-size:14px;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  padding-bottom:8px;
}

/* LEAD CARD */
.lead{
  background:#f9fafb;
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  font-size:13px;
}

.lead-title{
  font-weight:600;
}

.details{
  display:none;
  margin-top:6px;
  font-size:12px;
}

.toggle{
  background:none;
  border:none;
  color:var(--accent);
  font-size:12px;
  cursor:pointer;
  padding:0;
  margin:4px 0;
}

.delete-btn{
  width:100%;
  margin-top:6px;
  padding:6px;
  background:var(--danger);
  color:white;
  border:none;
  border-radius:8px;
  font-size:12px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h1>Sales Pipeline CRM</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div class="container">

<!-- SUMMARY -->
<div class="summary">
  <div class="box">
    <h4>Total Deal Amount</h4>
    <p>â‚¹<span id="totalAmount">0</span></p>
  </div>
  <div class="box">
    <h4>Total Won</h4>
    <p style="color:var(--success)">â‚¹<span id="totalWon">0</span></p>
  </div>
  <div class="box">
    <h4>Total Loss</h4>
    <p style="color:var(--loss)">â‚¹<span id="totalLoss">0</span></p>
  </div>
</div>

<div class="top-section">

<!-- ADD LEAD -->
<div class="add-card">
  <h3>Add New Lead</h3>
  <input id="company" placeholder="Company Name">
  <input id="person" placeholder="Contact Person">
  <input id="email" placeholder="Email">
  <input id="phone" placeholder="Phone">
  <input id="value" type="number" placeholder="Deal Value (â‚¹)">
  <button class="form-btn" onclick="addLead()">Add Lead</button>
</div>

<!-- PIPELINE -->
<div class="pipeline" id="pipeline"></div>

</div>
</div>

<script>
const socket = io();
const stages=["Lead","Contacted","Qualified","Proposal","Won","Lost"];

function logout(){
  localStorage.removeItem("token");
  window.location.href="login.html";
}

function toggle(id){
  const el=document.getElementById("d"+id);
  el.style.display = el.style.display==="none" ? "block" : "none";
}

async function loadLeads(){
  const res=await fetch("/api/leads");
  const data=await res.json();
  pipeline.innerHTML="";

  let total=0, won=0, loss=0;

  stages.forEach(stage=>{
    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`<h3>${stage}</h3>`;

    data.filter(l=>l.stage===stage).forEach(l=>{
      const v=Number(l.dealValue||0);
      total+=v;
      if(stage==="Won") won+=v;
      if(stage==="Lost") loss+=v;

      col.innerHTML+=`
        <div class="lead">
          <div class="lead-title">${l.companyName} â€” â‚¹${v}</div>
          <button class="toggle" onclick="toggle('${l._id}')">View details</button>
          <div class="details" id="d${l._id}">
            ðŸ‘¤ ${l.contactPerson}<br>
            ðŸ“§ ${l.email}<br>
            ðŸ“ž ${l.phone}
          </div>
          <select onchange="moveLead('${l._id}',this.value)">
            ${stages.map(s=>`<option ${s===l.stage?"selected":""}>${s}</option>`).join("")}
          </select>
          <button class="delete-btn" onclick="deleteLead('${l._id}')">Delete</button>
        </div>`;
    });

    pipeline.appendChild(col);
  });

  totalAmount.innerText=total;
  totalWon.innerText=won;
  totalLoss.innerText=loss;
}

async function addLead(){
  await fetch("/api/leads",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      companyName:company.value,
      contactPerson:person.value,
      email:email.value,
      phone:phone.value,
      dealValue:value.value
    })
  });

  company.value=person.value=email.value=phone.value=value.value="";
  socket.emit("leadChanged");
}

async function moveLead(id,stage){
  await fetch("/api/leads/"+id,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({stage})
  });
  socket.emit("leadChanged");
}

async function deleteLead(id){
  if(!confirm("Delete this lead?")) return;
  await fetch("/api/leads/"+id,{method:"DELETE"});
  socket.emit("leadChanged");
}

socket.on("refreshLeads",loadLeads);
loadLeads();
</script>

</body>
</html>
